parameters:
- name: task_name
  type: string

steps:
- checkout: self
  fetchDepth: 1

- checkout: ConfigChange
  fetchDepth: 1

- checkout: AzureDevOps
  fetchDepth: 1

# Use node 8, npm 5
- task: NodeTool@0
  displayName: Use node 10
  inputs:
    versionSpec: 10.x

- script: |
    cd azure-pipelines-tasks
    npm install
  displayName: npm install

- task: DownloadBuildArtifacts@0
  inputs:
    buildType: specific
    project: TestProject
    buildVersionToDownload: specific
    buildId: 822
    pipeline: FORK-TASKS
    artifactName: hotfix
    downloadPath: hotfixArtifact
  displayName: Download hotfix Artifact

# returns currentSprint
- template: set-current-sprint-variable.yml

# returns branchName
- template: generate-branch-name.yml
  parameters:
    postfix: hotfix
    currentSprint: '$(currentSprint)'

- powershell: |
    $hotfixFolderPath = "tfs/m$(currentSprint)/${{ parameters.task_name }}-hotfix"
    Write-Host $hotfixFolderPath
    Copy-Item -Path hotfixArtifact/hotfix -Destination AzureDevOps.ConfigChange/$hotfixFolderPath -Recurse
    Write-Host "##vso[task.setVariable variable=hotfixFolderPath]$hotfixFolderPath"
  displayName: Move HotFix files

- bash: |
    echo $(branchName)
    cd azure-pipelines-tasks/ci/courtesy-push
    npm install
    node push-hotfix-branch.js "$(hotfixFolderPath)"
    node open-hotfix-pr.js
  env:
    TOKEN: $(AzDoToken)
    TASK_NAME: ${{ parameters.task_name }}
    REPOSITORY: AzureDevOps.ConfigChange
    BRANCH: '$(branchName)'
  failOnStderr: true
  displayName: Open PR in ConfigChange

- powershell: |
    cd azure-pipelines-tasks/ci/courtesy-push
    node create-hotfix-release.js $(hotfixFolderPath) ${{ parameters.task_name }}
  displayName: Create Release in AzureDevOps.ConfigChange
  env:
    TOKEN: $(AzDoToken)
