parameters:
- name: task_name
  type: string

steps:
- checkout: self
  fetchDepth: 1

- checkout: AzureDevOps
  fetchDepth: 1

# Use node 8, npm 5
- task: NodeTool@0
  displayName: Use node 10
  inputs:
    versionSpec: 10.x



- task: DownloadBuildArtifacts@0
  inputs:
    buildType: specific
    buildVersionToDownload: specific
    project: TestProject
    buildId: 841
    pipeline: FORK-TASKS
    artifactName: IndividualNugetPackages
    downloadPath: IndividualNugetPackagesDownloaded
  displayName: Download Artifact

- script: node azure-pipelines-tasks\ci\courtesy-push\courtesy-push.js AzureDevOps IndividualNugetPackagesDownloaded\IndividualNugetPackages\unified_deps.xml
  displayName: Update unified deps

- bash:  |
    set -x
    cd azure-pipelines-tasks
    npm install
    cd ../azure-pipelines-tasks/ci/courtesy-push
    npm install
    node push-hotfix-branch.js
    node open-hotfix-pr.js AzureDevOps "${{ parameters.task_name }}" "$(username)"
  # $repositoryId $hotfixBranch $taskName
  env:
    TOKEN: $(AzDoToken)
    REPOSITORY: "AzureDevOps"
    TASK_NAME: "${{ parameters.task_name }}"
    USERNAME: "$(username)"

# - powershell: |

#     $gitUrl = "https://$(AzDoToken)@dev.azure.com/v-mazayt0/AzureDevOps/_git/AzureDevOps"
#     $repositoryId = "AzureDevOps"

#     node azure-pipelines-tasks\ci\courtesy-push\create-hotfix-branch.js

#     Write-Host "Pushing hotfixBranch to AzureDevOps"
#     cd AzureDevOps
#     git checkout -b $hotfixBranch
#     git config --global user.email "$(username)@microsoft.com"
#     git config --global user.name "$(username)"

#     git add .nuget\externals\UnifiedDependencies.xml
    
#     git commit -m "Courtesy bump of tasks"
#     git push $gitUrl $hotfixBranch --force

#     Write-Host "Creating Pull Request"
#     cd ..\azure-pipelines-tasks\ci\courtesy-push
#     npm install
#     node open-hotfix-pr.js $repositoryId $hotfixBranch $taskName
#   displayName: Create PR in Azure DevOps
#   env:
#     TOKEN: $(AzDoToken)
#     REPOSITORY: "AzureDevOps"
#     TASK_NAME: "${{ parameters.task_name }}"
#     USERNAME: "$(username)"
#   enabled: false